const cds = require('../../index'), { User } = cds, { decodeURI } = cds.utils
const libx = require('../../../libx/_runtime')
const LOG = cds.log('odata')

module.exports = function ODataAdapter (srv) { return [
  (req, _, next) => {
    let u = req.user
    req.user = u instanceof User ? u : new User(u)

    let url = decodeURI(req.originalUrl)
    LOG && LOG (req.method, url, req.body||'')
    if (/\$batch/.test(req.url))  req.on ('dispatch', (req) => {
      let path = decodeURI(req._path)
      LOG && LOG ('>', req.event, path, req._query||'')
      if (LOG._debug && req.query) LOG.debug (req.query)
    })

    next()
  },
  ...cds.env.features.odata_new_adapter ? [
    require('../../../libx/odata/service-document')(srv),
    require('../../../libx/odata/metadata')(srv),
  ] : [],
  libx.to.odata_v4 (srv)
]}
