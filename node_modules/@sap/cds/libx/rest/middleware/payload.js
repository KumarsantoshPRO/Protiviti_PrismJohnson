const { base64ToBuffer } = require('../../_runtime/common/utils/binary')

module.exports = (req, res, next) => {
  const { _srv, _query, _data, _operation } = req
  let definition = _operation || _query.__target
  if (typeof definition === 'string') definition = _srv.model.definitions[definition] || _srv.model.definitions[definition.split(':$:')[0]].actions[definition.split(':$:')[1]]

  if (!(_data && _srv && definition)) return next()

  base64ToBuffer(_data, _srv, definition)

  next()
}
